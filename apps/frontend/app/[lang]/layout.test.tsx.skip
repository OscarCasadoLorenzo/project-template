import "@testing-library/jest-dom";
import { render, screen } from "@testing-library/react";
import RootLayout, { generateStaticParams, metadata } from "./layout";

// Mock child components
jest.mock("@/components/LanguageSwitcher", () => ({
  __esModule: true,
  default: ({ currentLocale }: { currentLocale: string }) => (
    <div data-testid="language-switcher">
      Language Switcher: {currentLocale}
    </div>
  ),
}));

jest.mock("@/components/sidebar", () => ({
  Sidebar: () => <div data-testid="sidebar">Sidebar</div>,
}));

jest.mock("../providers", () => ({
  Providers: ({ children }: { children: React.ReactNode }) => (
    <div data-testid="providers">{children}</div>
  ),
}));

// Mock next-intl/server
jest.mock("next-intl/server", () => ({
  getMessages: jest.fn().mockResolvedValue({
    common: {
      welcome: "Welcome",
    },
  }),
}));

describe("RootLayout", () => {
  const defaultParams = Promise.resolve({ lang: "en" as const });

  it("renders the layout with all main sections", async () => {
    const layout = await RootLayout({
      children: <div>Test Content</div>,
      params: defaultParams,
    });

    const { container } = render(layout);

    // Check for main structure
    expect(container.querySelector("html")).toHaveAttribute("lang", "en");
    expect(screen.getByTestId("sidebar")).toBeInTheDocument();
    expect(screen.getByTestId("language-switcher")).toBeInTheDocument();
    expect(screen.getByText("Test Content")).toBeInTheDocument();
  });

  it("sets correct locale in NextIntlClientProvider", async () => {
    const layout = await RootLayout({
      children: <div>Test Content</div>,
      params: Promise.resolve({ lang: "es" as const }),
    });

    const { container } = render(layout);

    expect(container.querySelector("html")).toHaveAttribute("lang", "es");
  });

  it("renders children inside main content area", async () => {
    const testContent = <div data-testid="test-child">Child Content</div>;
    const layout = await RootLayout({
      children: testContent,
      params: defaultParams,
    });

    render(layout);

    const mainElement = screen.getByRole("main");
    expect(mainElement).toBeInTheDocument();
    expect(screen.getByTestId("test-child")).toBeInTheDocument();
  });

  it("wraps content with Providers", async () => {
    const layout = await RootLayout({
      children: <div>Test Content</div>,
      params: defaultParams,
    });

    render(layout);

    expect(screen.getByTestId("providers")).toBeInTheDocument();
  });

  it("applies Inter font class to body", async () => {
    const layout = await RootLayout({
      children: <div>Test Content</div>,
      params: defaultParams,
    });

    const { container } = render(layout);

    const body = container.querySelector("body");
    expect(body).toBeInTheDocument();
  });

  it("has suppressHydrationWarning on html element", async () => {
    const layout = await RootLayout({
      children: <div>Test Content</div>,
      params: defaultParams,
    });

    const { container } = render(layout);

    expect(container.querySelector("html")).toHaveAttribute(
      "suppressHydrationWarning",
    );
  });

  describe("generateStaticParams", () => {
    it("returns all supported locales", () => {
      const params = generateStaticParams();

      expect(params).toEqual([{ lang: "en" }, { lang: "es" }]);
    });
  });

  describe("metadata", () => {
    it("exports correct metadata", () => {
      expect(metadata).toEqual({
        title: "Project Template",
        description: "A character and campaign management tool",
      });
    });
  });
});
